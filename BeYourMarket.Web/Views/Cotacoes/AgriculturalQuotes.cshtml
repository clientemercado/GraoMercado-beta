@using MoreLinq;
@model BeYourMarket.Web.Models.SearchListingModel

@{
    ViewBag.Title = CacheHelper.Settings.Name;
    var navBarLogoPath = ImageHelper.GetLogoImagePath("logo_sem_fundo_horizontal");
}

@{ ViewBag.Title = "[[[Mercado Agrícola]]]"; }

@section Styles {
    <link href="~/Content/bootstrap-fileinput/css/fileinput.min.css" rel="stylesheet" />
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link href="~/Content/home.css" rel="stylesheet" />
</head>

@* start - navbar *@
<nav class="navbar navbar-default">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="@Url.Action("Index", "Home", new {})">
            <img id="navbar-logo" alt="Logo" src='@navBarLogoPath' />
        </a>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
            <li class="active">
                <a href="/">Início<span class="sr-only">(current)</span></a>
            </li>
            <li>
                <a href="#services">Serviços</a>
            </li>
            <li>
                <a href="@Url.Action("AgriculturalQuotes", "Cotacoes", new { oqeq = @ViewBag.oqeq })">Mercado Agrícola</a>
            </li>
            <li>
                <a href="@Url.Action("LivestockQuotes", "Cotacoes", new { oqeq = @ViewBag.oqeq })">Mercado Pecuária</a>
            </li>
            @*<li>
                    <a href="#products">Destaques</a>
                </li>*@
            <li>
                <a href="@Url.Action("Contact", "Home", new { oqeq = @ViewBag.oqeq })">Contate-nos</a>
            </li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
            <li>
                @Html.ActionLink("[[[Criar Conta]]]", "Register", "Account", new { area = string.Empty }, htmlAttributes: new { id = "registerLink" })
            </li>
            <li>
                @Html.ActionLink("[[[Entrar]]]", "Login", "Account", new { area = string.Empty, oqeq = 0 }, htmlAttributes: new { id = "loginLink" })
            </li>
        </ul>
    </div>
</nav>
@* end - navbar *@

@* start - header *@
<div id="header">
    <ul>
        <li>
            <div class="image_title">
                <p>Frutas, Verduras e Legumes</p>
            </div>
            <div>
                <a href="#">
                    <h2>Frutas, Verduras e Legumes</h2>
                    <p>Compre e Venda de Frutas, Verduras e Legumes</p>
                </a>
            </div>
        </li>
        <li>
            <div class="image_title">
                <p>Grãos</p>
            </div>
            <div>
                <a href="#">
                    <h2>Grãos</h2>
                    <p>Faça sua oferta de Compra ou Venda de variados tipos de Grãos</p>
                </a>
            </div>
        </li>
        <li>
            <div class="image_title">
                <p>Orgânicos</p>
            </div>
            <div>
                <a href="#">
                    <h2>Orgânicos</h2>
                    <p>Compra e Venda de produtos Orgânicos e de qualidade</p>
                </a>
            </div>
        </li>
        <li>
            <div class="image_title">
                <p>Animais</p>
            </div>
            <div>
                <a href="#">
                    <h2>Animais</h2>
                    <p>Compra e Venda de Animais de variados tipos</p>
                </a>
            </div>
        </li>
        <li>
            <div class="image_title">
                <p>Insumos Agrícolas</p>
            </div>
            <div>
                <a href="#">
                    <h2>Insumos Agrícolas</h2>
                    <p>Cotação em Grupo ou Individual, para compra de Insumos Agrícolas</p>
                </a>
            </div>
        </li>
        <li>
            <div class="image_title">
                <p>Máquinas, Ferramentas e Tecnologia</p>
            </div>
            <div>
                <a href="#">
                    <h2>Máquinas, Ferramentas e Tecnologia</h2>
                    <p>Venda de Máquinas, Ferramentas e prestação de Serviços Tecnológicos</p>
                </a>
            </div>
        </li>
    </ul>
</div>
@* end - header *@

@* start - main *@
<section id="quotes" class="container">
    <p class="text-center fs-lg-1"><font color="#4682B4">COTAÇÕES DO MERCADO AGRÍCOLA</font></p>
        <div class="container" id="data"></div>
</section>
@* end - main *@

<footer class="mainfooter" id="about">
    <div class="footer-middle">
        <div class="container">
            <div class="row">
                <div class="col-md-4 col-sm-12">
                    <div class="footer-pad">
                        <h4>Conheça o GrãoMercado</h4>
                        <ul class="list-unstyled">
                            <li><a href="#"><a href="@Url.Action("Sobre", "Home", new { oqeq = @ViewBag.oqeq })">Sobre o GrãoMercado</a></a></li>
                            <li><a href="@Url.Action("Novidades", "Home", new { oqeq = @ViewBag.oqeq })">Novidades</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12">
                    <div class="footer-pad">
                        <h4>Institucional</h4>
                        <ul class="list-unstyled">
                            <li><a href="@Url.Action("TermosUso", "Home", new { oqeq = @ViewBag.oqeq })">Termos de Uso</a></li>
                            <li><a href="@Url.Action("PoliticasPrivacidade", "Home", new { oqeq = @ViewBag.oqeq })">Políticas de Privacidade</a></li>
                            <li><a href="@Url.Action("TrocasDevolucoes", "Home", new { oqeq = @ViewBag.oqeq })">Trocas e Devoluções</a></li>
                            <li><a href="@Url.Action("TermosBureauCompartilhamento", "Home", new { oqeq = @ViewBag.oqeq })">Termo de Consulta a Bureaus e Compartilhamento de Dados</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12">
                    <div class="footer-pad">
                        <h4>Precisa de ajuda?</h4>
                        <ul class="list-unstyled">
                            <li><a href="@Url.Action("FaleConosco", "Home", new { oqeq = @ViewBag.oqeq })">Fale Conosco</a></li>
                            <li><a href="@Url.Action("PerguntasFrequentes", "Home", new { oqeq = @ViewBag.oqeq })">Perguntas Frequentes</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-4 col-sm-12">
                    <div class="footer-pad">
                        <h4>Você é um distribuidor?</h4>
                        <ul class="list-unstyled">
                            <li><a href="@Url.Action("CadastreSuaLoja", "Home", new { oqeq = @ViewBag.oqeq })">Cadastre sua loja para vender online</a></li>
                            <li><a href="@Url.Action("PlataformaDistribuidor", "Home", new { oqeq = @ViewBag.oqeq })">Acessar a plataforma do distribuidor</a></li>
                        </ul>
                    </div>
                </div>
                @*<div class="col-md-4 col-sm-12">
                        <div class="footer-pad social">
                            <h4>Social</h4>
                            <ul class="social-network social-circle">
                                <li><a href="#" class="iconFacebook" title="Facebook"><i class="fa fa-facebook"></i></a></li>
                                <li><a href="#" class="iconLinkedin" title="Linkedin"><i class="fa fa-linkedin"></i></a></li>
                                <li><a href="#" class="iconInstagram" title="Linkedin"><i class="fa fa-instagram"></i></a></li>
                            </ul>
                        </div>
                    </div>*@
            </div>
            <div class="row">
                <button onclick="topFunction()" id="to-top" title="Go to top">
                    <i class="fa fa-chevron-circle-up"></i>
                </button>
            </div>
            <div class="row">
                <div class="col-md-12 copy">
                    <p class="text-center">&copy; @DateTime.Now.Year -  graomercado.com All rights reserve</p>
                </div>
            </div>
        </div>
    </div>
</footer>
@* end - about/footer *@

<script>
    //
    let date = new Date();
    const dd = String(date.getDate() - 1).padStart(2, '0');
    const mm = String(date.getMonth() + 1).padStart(2, '0'); //January is 0!
    const yyyy = date.getFullYear();
    date = `${dd}/${mm}/${yyyy}`;
    const url = "https://www.bbmnet.com.br/bbmnet/api.php?";
    const state = "estado=ES";
    const query = "&datainicial=" + date;

    debugger;
    window.onload = loadAgriculturalQuote(url, query);

    function dateMask(date) {
        date = date.replace(/\D/g, '');
        return `${date.slice(6, date.length)}/${date.slice(4, date.length - 2)}/${date.slice(0, 4)}`;
    }

    const tableAgriculturalSubTabs = (params) => {
        const subTab = params.map((obj, index) => obj.Estados.length > 0 ? `<li class="${index === 0 ? 'active' : ''}">
                    <a data-toggle="tab" href="#${obj.Codigo}">${obj.Nome}</a>
                </li>
                `: null
        ).join(" ");

        const subContent = params.map((obj, index) => obj.Estados.length > 0 ? `
                <div id="${obj.Codigo}" class="tab-pane fade in ${index === 0 ? 'active' : ''}">
                    <h3>${obj.Nome}</h3>
                    <h5>${obj.UnidadeMedida}</h5>                       
                    ${tableAgriculturalStates(obj.Estados)}                                                  
                </div>
                `: null
        ).join(" ");

        return `<ul class="nav nav-tabs">
            ${subTab}
           </ul>
            <div class="tab-content">
             ${subContent}
            </div>
            `;
    };

    const tableAgriculturalStates = (states) => `
${states ?.map((st, i) => `
<div class="table-responsive" style="margin-bottom:10px;">
    <table class="table table-striped table-hover">
        <tbody>
            <tr style="background-color:#028941;color:white;">
                <th>${st.Nome}</th>
                <th>Preço</th>
                <th>Variação Dia</th>
                <th>Data</th>
            </tr>
            ${st ?.Cidades.map(ci => `
                 <tr>
                    <td>${ci.Nome}</td>
                    <td>${ci.Preco}</td>
                    <td>${ci.Variacao}</td>
                    <td>${dateMask(ci.Data)}</td>
                 </tr>
                `).join(' ')}
            </tbody>
        </table>
        </div>
        `).join(' ')}
    `;

    function loadAgriculturalQuote(url, query) {
        $.get(url + query, function (data, status) {
            if (!status === 'success') {
                $('#data').append(`
              <section class="loading">
                  <span class="loadWords">Loading...</span>
                  <span class="loading__anim"></span>
              </section>
              `);
                return;
            }
            const response = data.BBMNETCotacoes.map(item => {
                const key = Object.keys(item)[0];
                const name = key.split(' ')[0];
                const quote = item[key][0];
                return {
                    ...quote,
                    NomeFormatado: name,
                }
            }).reduce(function (r, a) {
                r[a.NomeFormatado] = r[a.NomeFormatado] || [];
                r[a.NomeFormatado].push(a);
                return r;
            }, Object.create(null));

            const tab = Object.keys(response).map((key, index) => `<li class="${index === 0 ? 'active' : ''}">
                          <a data-toggle="tab" href="#${response[key][0].Codigo}">${response[key].length === 1 ? response[key][0].Nome : key}</a>
                      </li>
                      `).join(" ");

            const content = Object.keys(response).map((key, index) => {
                const states = response[key][0].Estados;
                return `
                      <div id="${response[key][0].Codigo}" class="tab-pane fade in ${index === 0 ? 'active' : ''}">
                       ${states ?.length === 0 ?
                    `<h3 style="margin-top:30px;margin-bottom:30px;"> Clique na aba abaixo para ver a cotação</h3>` :
                        `<h3>${response[key][0].Nome}</h3>
                             <h5>${response[key][0].UnidadeMedida}</h5>`
                }   
                                           
                            ${states ?.length === 0 ? tableAgriculturalSubTabs(response[key], response[key][0].NomeFormatado) : tableAgriculturalStates(states)}                                                  
                      </div>
                      `;
            }).join(" ");

            $('#data').append(
                `<ul class="nav nav-tabs">
                  ${tab}
               </ul>
               <div class="tab-content">
               ${content}
               </div>
               `
            );

        });
    }
</script>